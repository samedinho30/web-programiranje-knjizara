<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Review Form</title>
    <link rel="stylesheet" th:href="@{/styles/style.css}" href="/styles/style.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px; }

    </style>
</head>
<body>
<p class="back-link"><a th:href="@{'/books/' + ${review.book.id}}">‚Üê Back to Book</a></p>

<h1 th:if="${review.id == null}">Add Review for <span th:text="${review.book.title}"></span></h1>
<h1 th:if="${review.id != null}">Edit Review</h1>

<!-- Fixed form to use proper hidden field for book ID instead of nested book.id -->
<form th:if="${review.id == null}" th:action="@{/reviews}" method="post" th:object="${review}">
    <!-- Use a simple hidden field with the book ID value directly -->
    <input type="hidden" id="bookId" name="bookId" th:value="${review.book.id}">

    <div class="form-group">
        <label for="reviewerName">Your Name:</label>
        <input type="text" id="reviewerName" name="reviewerName" th:field="*{reviewerName}" required>
    </div>
    <div class="form-group">
        <label for="rating">Rating (1-5):</label>
        <select id="rating" name="rating" required>
            <option value="">-- Select Rating --</option>
            <option value="1">1 - Poor</option>
            <option value="2">2 - Fair</option>
            <option value="3">3 - Good</option>
            <option value="4">4 - Very Good</option>
            <option value="5">5 - Excellent</option>
        </select>
    </div>
    <div class="form-group">
        <label for="comment">Your Review:</label>
        <textarea id="comment" name="comment" th:field="*{comment}"></textarea>
    </div>
    <div class="form-group">
        <label for="year">Year:</label>
        <input type="number" id="year" name="year" th:field="*{year}">
    </div>
    <button type="submit">Save Review</button>
</form>

<!-- Changed to PUT method with JavaScript and added hidden ID field -->
<form th:if="${review.id != null}" th:action="@{/reviews/{id}(id=${review.id})}" method="post" th:object="${review}">
    <input type="hidden" name="id" th:field="*{id}">
    <input type="hidden" name="book.id" th:field="*{book.id}">
    <div class="form-group">
        <label for="reviewerName">Your Name:</label>
        <input type="text" id="reviewerName" name="reviewerName" th:field="*{reviewerName}" required>
    </div>
    <div class="form-group">
        <label for="rating">Rating (1-5):</label>
        <select id="rating" name="rating" required>
            <option value="">-- Select Rating --</option>
            <option value="1">1 - Poor</option>
            <option value="2">2 - Fair</option>
            <option value="3">3 - Good</option>
            <option value="4">4 - Very Good</option>
            <option value="5">5 - Excellent</option>
        </select>
    </div>
    <div class="form-group">
        <label for="comment">Your Review:</label>
        <textarea id="comment" name="comment" th:field="*{comment}"></textarea>
    </div>
    <div class="form-group">
        <label for="year">Year:</label>
        <input type="number" id="year" name="year" th:field="*{year}">
    </div>
    <button type="button" onclick="updateReviewWithPut()">Update Review</button>
    <!-- Added delete button for edit form -->
    <button type="button" onclick="deleteReview()" style="background-color: #f44336; margin-left: 10px;">Delete Review</button>
</form>

<script>
    function updateReviewWithPut() {
        const id = document.querySelector('input[name="id"]').value;
        const bookId = document.querySelector('input[name="book.id"]').value;
        const reviewerName = document.querySelector('input[name="reviewerName"]').value;
        const rating = document.querySelector('select[name="rating"]').value;
        const comment = document.querySelector('textarea[name="comment"]').value;
        const year = document.querySelector('input[name="year"]').value;

        const ratingInt = parseInt(rating);
        if (ratingInt < 1 || ratingInt > 5) {
            alert('Rating must be between 1 and 5');
            return;
        }

        console.log('[v0] Updating review:', { id, bookId, reviewerName, ratingInt, comment, year });

        fetch(`/reviews/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: parseInt(id),
                reviewerName: reviewerName,
                rating: ratingInt,
                comment: comment,
                year: year ? parseInt(year) : null,
                book: { id: parseInt(bookId) }
            })
        })
            .then(response => {
                console.log('[v0] Response status:', response.status);
                if (response.ok) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error(`Server error: ${response.status} - ${text}`);
                    });
                }
            })
            .then(data => {
                console.log('[v0] Update successful:', data);
                alert('Review updated successfully!');
                window.location.href = `/books/${bookId}`;
            })
            .catch(error => {
                console.error('[v0] Error updating review:', error);
                alert('Error updating review: ' + error.message);
            });
    }

    <!-- Added delete function with confirmation -->
    function deleteReview() {
        if (confirm('Are you sure you want to delete this review?')) {
            const id = document.querySelector('input[name="id"]').value;
            const bookId = document.querySelector('input[name="book.id"]').value;
            window.location.href = `/reviews/${id}/delete?redirect=/books/${bookId}`;
        }
    }
</script>
</body>
</html>
